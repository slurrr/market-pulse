<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARKET PULSE v0.8 - ORTHOGONAL STATE</title>
    <style>
        :root {
            --bg: #050505;
            --panel-bg: #0b0b0b;
            --text-main: #e0e0e0;
            --text-dim: #555;
            --text-dark: #222;

            --accent-green: #00ff66;
            --accent-red: #ff3333;
            --accent-yellow: #ffcc00;
            --accent-blue: #00ccff;
            --accent-purple: #cc00ff;
            --accent-orange: #ff6600;

            --grid-color: #1a1a1a;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0px var(--accent-red);
            }

            50% {
                box-shadow: 0 0 15px var(--accent-red);
            }

            100% {
                box-shadow: 0 0 0px var(--accent-red);
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0px var(--accent-green);
            }

            50% {
                box-shadow: 0 0 15px var(--accent-green);
            }

            100% {
                box-shadow: 0 0 0px var(--accent-green);
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'JetBrains Mono', 'Roboto Mono', monospace;
            margin: 0;
            padding: 4px;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 40px 1fr;
            gap: 4px;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            background: var(--panel-bg);
            border: 1px solid var(--grid-color);
            border-bottom: 2px solid #222;
            transition: all 0.3s;
        }

        header.pulse-up {
            animation: pulse-green 1s infinite;
            border-color: var(--accent-green);
        }

        header.pulse-down {
            animation: pulse-red 1s infinite;
            border-color: var(--accent-red);
        }

        .system-status {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .main-regime {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* GRID */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            /* 4 Columns */
            grid-template-rows: 1fr 1fr;
            gap: 4px;
            height: 100%;
        }

        /* PANELS */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--grid-color);
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            font-size: 0.65rem;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            border-bottom: 1px solid #1a1a1a;
            padding-bottom: 2px;
            display: flex;
            justify-content: space-between;
        }

        /* TYPOGRAPHY */
        .val-giant {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 0.9;
            letter-spacing: -1px;
        }

        .val-big {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1;
        }

        .val-norm {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .lbl {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .c-up {
            color: var(--accent-green);
        }

        .c-down {
            color: var(--accent-red);
        }

        .c-warn {
            color: var(--accent-yellow);
        }

        .c-cool {
            color: var(--accent-blue);
        }

        .c-wild {
            color: var(--accent-purple);
        }

        .c-heat {
            color: var(--accent-orange);
        }

        /* VIZ */
        .bar-container {
            background: #111;
            height: 4px;
            width: 100%;
            margin: 4px 0;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease-out;
        }

        .kv-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }

        /* TAPE */
        .tape-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 0.6rem;
            opacity: 0.8;
        }

        .tape-row {
            display: grid;
            grid-template-columns: 30px 1fr 1fr;
            margin-bottom: 2px;
            border-bottom: 1px solid #0f0f0f;
        }

        /* PULSE FX */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0px var(--accent-red);
                border-color: var(--accent-red);
            }

            50% {
                box-shadow: 0 0 20px var(--accent-red);
                border-color: var(--accent-red);
            }

            100% {
                box-shadow: 0 0 0px var(--accent-red);
                border-color: #222;
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0px var(--accent-green);
                border-color: var(--accent-green);
            }

            50% {
                box-shadow: 0 0 20px var(--accent-green);
                border-color: var(--accent-green);
            }

            100% {
                box-shadow: 0 0 0px var(--accent-green);
                border-color: #222;
            }
        }

        /* EVENT LOG */
        .event-log {
            font-size: 0.65rem;
            color: #888;
            margin-top: 5px;
        }

        .event-row {
            border-left: 2px solid #333;
            padding-left: 5px;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <header id="main-header">
        <div>
            <span class="lbl" style="color: #666;">MARKET PULSE v0.8</span>
            <span class="lbl" id="ws-status"> :: DISCONNECTED</span>
        </div>
        <div id="regime-banner" class="main-regime">INITIALIZING</div>
        <div style="text-align: right;">
            <div class="lbl">LOCAL</div>
            <div id="clock" style="font-family: monospace;">--:--:--</div>
        </div>
    </header>

    <div class="dashboard-grid">

        <div class="panel" style="grid-column: 1; grid-row: 1 / 3;">
            <div class="panel-header">CORE REALITY</div>

            <div style="margin-bottom: 10px;">
                <div class="lbl">BTC PRICE</div>
                <div id="btc-price" class="val-giant">--,--</div>
                <div class="kv-row" style="margin-top: 5px;">
                    <span class="lbl">VELOCITY (10s)</span>
                    <span id="vel-val" class="val-norm">0.00</span>
                </div>
                <div class="bar-container">
                    <div id="vel-bar" class="bar-fill" style="width: 50%; background: #333;"></div>
                </div>
            </div>

            <div style="margin-top: 5px; border-top: 1px dashed #222; padding-top: 5px; flex-shrink: 0;">
                <div class="kv-row">
                    <span class="lbl" style="color:#888">SESSION VWAP</span>
                    <span id="vwap-val" class="val-norm" style="color: var(--text-main)">WAIT...</span>
                </div>
                <div class="kv-row">
                    <span class="lbl" style="color:#888">VWAP DELTA</span>
                    <span id="vwap-delta" class="val-norm">--</span>
                </div>
                <div id="trend-regime" class="lbl" style="text-align:center; color: #555; margin-top:2px;">
                    initializing</div>
            </div>

            <div style="margin-top: 15px;">
                <div class="panel-header">VOLATILITY STATE</div>
                <div class="kv-row"><span class="lbl">10m Range</span> <span id="vol-range" class="val-norm">--</span>
                </div>
                <div class="lbl" style="margin-top: 5px;">COMPRESSION</div>
                <div class="bar-container" style="height: 6px;">
                    <div id="vol-bar" class="bar-fill" style="width: 0%; background: var(--accent-blue);"></div>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px dashed #222; padding-top: 10px;">
                <div class="panel-header">STRUCTURAL ACCEPTANCE</div>
                <div class="lbl">TIME AT PRICE (Session)</div>
                <div id="acceptance-state" class="val-big" style="color: var(--accent-yellow);">EXPLORATION</div>
                <div class="lbl" style="margin-top: 2px;">Market is searching...</div>
            </div>

            <div style="margin-top: auto;">
                <div class="lbl">LAST 15m CHANGE</div>
                <div id="chg-15m" class="val-norm">--</div>
            </div>
        </div>

        <!-- COL 2: INVENTORY & IMBALANCE -->
        <div class="panel">
            <div class="panel-header">INVENTORY IMBALANCE</div>

            <div class="lbl">EFFORT (CVD) vs RESULT (PRICE)</div>
            <div style="display:flex; justify-content: space-between; margin-top: 5px;">
                <div style="font-size:0.7rem;">CVD: <span id="cvd-val">0</span></div>
                <div style="font-size:0.7rem;">Î”P: <span id="dp-val">0</span></div>
            </div>

            <div style="margin-top: 10px; text-align: center;">
                <div id="imbalance-state" class="val-big" style="color: #555;">BALANCED</div>
                <div class="lbl">STATE</div>
            </div>

            <div class="bar-container" style="margin-top:10px; height: 8px;">
                <div id="imbalance-bar" class="bar-fill" style="width: 50%; background: #555;"></div>
            </div>

            <!-- BASIS METRIC -->
            <div style="margin-top: 15px; border-top: 1px dashed #222; padding-top: 5px;">
                <div class="kv-row">
                    <span class="lbl">BASIS (SPOT - PERP)</span>
                    <span id="basis-val" class="val-norm">0.00</span>
                </div>
                <!-- Mini basis chart or bar could go here, for now just value -->
            </div>

            <div
                style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #444; margin-bottom: 5px; margin-top: 5px;">
                <span>ABSORPTION</span>
                <span>SQUEEZE</span>
            </div>

            <!-- RESTORED: SPOT VS PERP -->
            <div style="border-top: 1px dashed #222; padding-top: 10px;">
                <div class="lbl">SPOT VS PERP DELTA</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div id="spot-cvd-val" class="val-norm">S: 0</div>
                    <div id="perp-cvd-val" class="val-norm">P: 0</div>
                </div>
                <div class="bar-container" style="height: 6px;">
                    <div id="cvd-diff-bar" class="bar-fill" style="width: 50%; background: #444;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #444;">
                    <span>PERP LED</span>
                    <span>SPOT LED</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header" style="display:flex; justify-content:space-between;">
                ANOMALIES & STRUCTURE
                <span id="liq-total" style="color:var(--accent-red)">0k</span>
            </div>

            <!-- LIQUIDATION BAR -->
            <div class="lbl" style="margin-top:5px;">REKT: LONG vs SHORT (Session)</div>
            <div class="bar-container" style="height: 10px; margin-bottom: 5px;">
                <div id="liq-bar" class="bar-fill" style="width: 50%; background: var(--accent-green);"></div>
            </div>
            <div style="display:flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 15px;">
                <span id="liq-long-val" style="color:var(--accent-green)">L: 0</span>
                <span id="liq-short-val" style="color:var(--accent-red)">S: 0</span>
            </div>

            <div class="lbl">EXPECTATION BREACHES</div>
            <div id="failure-log" class="event-log">
                <!-- Log items -->
                <div class="event-row">Listening for anomalies...</div>
            </div>
        </div>


        <!-- COL 3: BREADTH & PARTICIPATION -->
        <div class="panel">
            <div class="panel-header">PARTICIPATION BREADTH</div>

            <div class="lbl">WHALE DOMINANCE (>50k Vol)</div>
            <div id="whale-dom-val" class="val-big">0%</div>
            <div class="bar-container" style="height: 6px;">
                <div id="whale-bar" class="bar-fill" style="width: 0%; background: var(--accent-purple);"></div>
            </div>

            <div style="margin-top: 15px;">
                <div class="lbl">LIQUIDITY QUALITY</div>
                <div id="liq-quality" class="val-norm" style="color: #666;">UNKNOWN</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">RELATIVE STRENGTH</div>
            <div class="kv-row"><span class="lbl">ETH / BTC</span> <span id="eth-str" class="val-norm">--</span>
            </div>
            <div class="kv-row"><span class="lbl">SOL / BTC</span> <span id="sol-str" class="val-norm">--</span>
            </div>
            <div class="kv-row"><span class="lbl">BNB / BTC</span> <span id="bnb-str" class="val-norm">--</span>
            </div>

            <div style="margin-top: 10px; border-top: 1px dashed #222; padding-top: 5px;">
                <div class="kv-row"><span class="lbl">BTC-ETH COUPLING</span> <span id="cor-val"
                        class="val-norm">--</span></div>
            </div>

            <div class="bar-container" style="margin-top: 10px;">
                <div id="rotation-bar" class="bar-fill" style="width: 50%; background: #444;"></div>
            </div>
            <div class="lbl" style="text-align: center;">ALTS <-> BTC</div>
        </div>

        <!-- COL 4: RAW TAPE -->
        <div class="panel" style="grid-column: 4; grid-row: 1 / 3;">
            <div class="panel-header">SIGNIFICANT TRADES (>50k)</div>
            <div id="tape-list" class="tape-container" style="flex-grow: 1;">
                <!-- JS -->
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        const WS_SPOT = 'wss://stream.binance.com:9443/stream?streams=btcusdt@trade/btcusdt@markPrice/ethusdt@trade/solusdt@trade/bnbusdt@trade';
        const WS_FUT = 'wss://fstream.binance.com/ws/btcusdt@aggTrade';
        const WS_LIQ = 'wss://fstream.binance.com/ws/!forceOrder@arr';

        // STATE
        const state = {
            btc: { current: 0, last: 0, history: [], startPrice: 0 },
            alts: { eth: 0, sol: 0, bnb: 0, ethStart: 0, solStart: 0, bnbStart: 0 },
            vol: { total: 0, whale: 0, buy: 0, sell: 0 }, // Session volume accumulators (decaying)
            perp: { buy: 0, sell: 0, price: 0 }, // Perp volume & price
            liq: { long: 0, short: 0 }, // Liquidation volumes
            tpo: {}, // Price bucket -> count
            cvd: 0, // Cumulative Volume Delta
            events: [], // Failure events
            lastHighVelEvent: null, // { time, price, dir }
            vwap: { sumProd: 0, sumVol: 0 },
            walls: {}, // price -> accumulated volume
            history: { btc: [], eth: [] } // For correlation (1s snapshots)
        };

        const ui = {
            header: document.getElementById('main-header'),
            status: document.getElementById('ws-status'),
            clock: document.getElementById('clock'),
            regime: document.getElementById('regime-banner'),
            // Core
            btcPrice: document.getElementById('btc-price'),
            velVal: document.getElementById('vel-val'),
            velBar: document.getElementById('vel-bar'),
            volRange: document.getElementById('vol-range'),
            volBar: document.getElementById('vol-bar'),
            chg15m: document.getElementById('chg-15m'),
            // Acceptance
            acceptState: document.getElementById('acceptance-state'),
            // Imbalance
            cvdVal: document.getElementById('cvd-val'),
            dpVal: document.getElementById('dp-val'),
            imbState: document.getElementById('imbalance-state'),
            imbBar: document.getElementById('imbalance-bar'),
            spotCvd: document.getElementById('spot-cvd-val'),
            perpCvd: document.getElementById('perp-cvd-val'),
            cvdDiffBar: document.getElementById('cvd-diff-bar'),
            basisVal: document.getElementById('basis-val'),
            // Failure & Liq
            failLog: document.getElementById('failure-log'),
            liqTotal: document.getElementById('liq-total'),
            liqBar: document.getElementById('liq-bar'),
            liqLong: document.getElementById('liq-long-val'),
            liqShort: document.getElementById('liq-short-val'),
            // Breadth
            whaleDom: document.getElementById('whale-dom-val'),
            whaleBar: document.getElementById('whale-bar'),
            liqQual: document.getElementById('liq-quality'),
            liqQual: document.getElementById('liq-quality'),
            // Rel Strength
            ethStr: document.getElementById('eth-str'),
            solStr: document.getElementById('sol-str'),
            bnbStr: document.getElementById('bnb-str'),
            corVal: document.getElementById('cor-val'),
            // VWAP
            vwapVal: document.getElementById('vwap-val'),
            vwapDelta: document.getElementById('vwap-delta'),
            trendRegime: document.getElementById('trend-regime'),
            tape: document.getElementById('tape-list')
        };

        // CONNECT
        const ws = new WebSocket(WS_SPOT);
        const wsFut = new WebSocket(WS_FUT);
        const wsLiq = new WebSocket(WS_LIQ);

        ws.onopen = () => { ui.status.innerText = ":: ONLINE"; ui.status.style.color = "var(--accent-green)"; };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.stream.includes('btcusdt@trade')) handleBTC(msg.data);
            else if (msg.stream.includes('trade')) handleAlt(msg.data, msg.stream.split('@')[0]);
        };

        wsFut.onmessage = (e) => {
            const t = JSON.parse(e.data);
            const price = parseFloat(t.p);
            const qty = parseFloat(t.q);
            const val = price * qty;
            const isSell = t.m;

            state.perp.price = price; // Track perp price

            if (isSell) state.perp.sell += val;
            else state.perp.buy += val;
        };

        wsLiq.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const liq = data.o; // Order object
            if (!liq) return;

            // "S": "SELL" -> Long liquidated (forced sell)
            // "S": "BUY"  -> Short liquidated (forced buy)
            const side = liq.S;
            const val = parseFloat(liq.q) * parseFloat(liq.p);

            if (side === 'SELL') state.liq.long += val;
            if (side === 'BUY') state.liq.short += val;

            if (val > 10000) {
                const type = side === 'SELL' ? 'LONG LIQ' : 'SHORT LIQ';
                const color = side === 'SELL' ? 'var(--accent-green)' : 'var(--accent-red)'; // Green for Long Liq (forced sell -> bullish absorption potential? NO. Forced sell is sell pressure. But traditionally Liqs = exhaustion)
                // Actually, use standard: Long Liq = forced sell = Red pressure. Short Liq = forced buy = Green pressure.
                // But for the visualizer, we want to know WHO got rekt. 
                logEvent(type, `$${(val / 1000).toFixed(1)}k @ ${parseFloat(liq.p).toFixed(0)}`, 'var(--accent-orange)');
            }
        };

        function handleBTC(t) {
            const price = parseFloat(t.p);
            const qty = parseFloat(t.q);
            const val = price * qty;
            const isSell = t.m;

            if (state.btc.current === 0) state.btc.startPrice = price;
            state.btc.last = state.btc.current;
            state.btc.current = price;
            state.btc.history.push({ t: Date.now(), p: price });

            // Vol & Whale Stats
            state.vol.total += val;
            if (isSell) { state.vol.sell += val; state.cvd -= val; }
            else { state.vol.buy += val; state.cvd += val; }

            if (val > 50000) {
                state.vol.whale += val;
                addTape(t, val, isSell);
            }

            // VWAP Accumulation
            state.vwap.sumProd += (price * qty);
            state.vwap.sumVol += qty;

            // Iceberg / Wall Detection (Heuristic: High Volume, Low Price Change)
            // We'll accumulate volume at specific price levels.
            // If a level absorbs > 50 BTC (approx 5M USD) without breaking, it's a wall.
            if (!state.walls[price]) state.walls[price] = 0;
            state.walls[price] += val;

            // Decay walls slowly to prevent stale levels
            // actually decay happens in loop

            if (state.walls[price] > 2000000) { // $2M absorbed
                // Check if price moved away? No, we are AT this price.
                // We need to check if we are STUCK here. 
                // Simple logic: huge volume at one price level = Interest.
                // We will log it if it gets really big.
                if (state.walls[price] > 5000000 && !state.walls[price + '_logged']) {
                    logEvent('ICEBERG', `>$5M absorbed at ${price}`, 'var(--accent-purple)');
                    state.walls[price + '_logged'] = true;
                }
            }

            // TPO (Acceptance)
            const bucket = Math.floor(price / 25) * 25; // $25 buckets
            state.tpo[bucket] = (state.tpo[bucket] || 0) + 1;

            // UI
            ui.btcPrice.innerText = price.toFixed(2);
            ui.btcPrice.style.color = price >= state.btc.last ? 'var(--accent-green)' : 'var(--accent-red)';
        }

        function handleAlt(t, s) {
            const p = parseFloat(t.p);
            if (s.includes('eth')) state.alts.eth = p;
            if (s.includes('sol')) state.alts.sol = p;
            if (s.includes('bnb')) state.alts.bnb = p;

            if (state.alts.ethStart === 0 && s.includes('eth')) state.alts.ethStart = p;
            if (state.alts.solStart === 0 && s.includes('sol')) state.alts.solStart = p;
            if (state.alts.bnbStart === 0 && s.includes('bnb')) state.alts.bnbStart = p;
        }

        function addTape(t, val, isSell) {
            const row = document.createElement('div');
            row.className = 'tape-row';
            row.innerHTML = `
                <span class="${isSell ? 'c-down' : 'c-up'}">${isSell ? 'SELL' : 'BUY'}</span>
                <span>${parseFloat(t.p).toFixed(0)}</span>
                <span>$${(val / 1000).toFixed(0)}k</span>
            `;
            ui.tape.prepend(row);
            if (ui.tape.children.length > 30) ui.tape.lastElementChild.remove();
        }

        function logEvent(type, desc, color) {
            const row = document.createElement('div');
            row.className = 'event-row';
            row.style.borderLeftColor = color;
            const time = new Date().toLocaleTimeString().split(' ')[0];
            row.innerHTML = `<span style="color:#aaa">[${time}]</span> <span style="color:${color}">${type}</span>: ${desc}`;
            ui.failLog.prepend(row);
            if (ui.failLog.children.length > 5) ui.failLog.lastElementChild.remove();
        }

        // ANALYSIS LOOP (1s)
        setInterval(() => {
            const now = Date.now();
            ui.clock.innerText = new Date().toLocaleTimeString();

            // Snapshot for Correlation
            if (state.btc.current > 0 && state.alts.eth > 0) {
                state.history.btc.push(state.btc.current);
                state.history.eth.push(state.alts.eth);
                if (state.history.btc.length > 300) { // Keep 5 mins
                    state.history.btc.shift();
                    state.history.eth.shift();
                }
            }

            // 1. VELOCITY & FAILURE DETECTION
            const h = state.btc.history;
            if (h.length < 10) return;

            // Prune history
            state.btc.history = h.filter(x => now - x.t < 900000); // 15m

            const pNow = state.btc.current;
            const p10s = h.find(x => x.t >= now - 10000)?.p || pNow;
            const vel = pNow - p10s;

            ui.velVal.innerText = vel.toFixed(2);
            ui.velVal.className = vel > 0 ? 'val-norm c-up' : (vel < 0 ? 'val-norm c-down' : 'val-norm');
            const velPct = Math.min(100, Math.max(0, 50 + (vel * 2)));
            ui.velBar.style.width = velPct + '%';
            ui.velBar.style.background = vel > 0 ? 'var(--accent-green)' : 'var(--accent-red)';

            // PULSE EFFECT
            ui.header.className = '';
            if (vel > 25) ui.header.className = 'pulse-up';
            if (vel < -25) ui.header.className = 'pulse-down';

            // Failure Logic
            if (Math.abs(vel) > 40 && !state.lastHighVelEvent) {
                // Register Event start
                state.lastHighVelEvent = { t: now, p: pNow, dir: vel > 0 ? 1 : -1, peak: pNow };
            } else if (state.lastHighVelEvent) {
                // Track outcome
                const e = state.lastHighVelEvent;
                if (e.dir === 1 && pNow > e.peak) e.peak = pNow;
                if (e.dir === -1 && pNow < e.peak) e.peak = pNow;

                // Check 10s later
                if (now - e.t > 10000) {
                    const moveSize = Math.abs(e.peak - e.p); // Size of move
                    const retracement = Math.abs(pNow - e.peak); // How much we gave back

                    if (retracement > moveSize * 0.8) {
                        logEvent('REJECTION', `Fast move to ${e.peak.toFixed(0)} fully retraced`, 'var(--accent-red)');
                    } else if (retracement < moveSize * 0.3) {
                        logEvent('VALIDATION', `Move to ${e.peak.toFixed(0)} accepted`, 'var(--accent-green)');
                    }
                    state.lastHighVelEvent = null;
                }
            }

            // 2. TPO / ACCEPTANCE
            const bucket = Math.floor(pNow / 25) * 25;
            const count = state.tpo[bucket] || 0;
            // Simple heuristic: if we've spent > 10% of ticks here, it's accepted
            const totalTicks = Object.values(state.tpo).reduce((a, b) => a + b, 0);
            const conc = count / totalTicks;

            if (conc > 0.15) {
                ui.acceptState.innerText = "ACCEPTED";
                ui.acceptState.style.color = "var(--accent-green)";
            } else if (conc > 0.05) {
                ui.acceptState.innerText = "BUILDING";
                ui.acceptState.style.color = "var(--text-main)";
            } else {
                ui.acceptState.innerText = "EXPLORATION";
                ui.acceptState.style.color = "var(--accent-yellow)";
            }

            // 3. INVENTORY IMBALANCE (CVD vs PRICE)
            // Normalize CVD since start
            const priceChg = pNow - state.btc.startPrice;
            ui.cvdVal.innerText = (state.cvd / 1000).toFixed(0) + 'k';
            ui.dpVal.innerText = priceChg.toFixed(0);

            // Heuristic: CVD and Price should move together.
            // If Price is UP but CVD is DOWN -> DIVERGENCE (Spot selling / perp aping?)
            let imbState = "BALANCED";
            let imbColor = "#555";
            let imbBarPos = 50;

            if (priceChg > 50 && state.cvd < -1000000) {
                imbState = "ABSORPTION (Bearish)";
                imbColor = "var(--accent-red)";
                imbBarPos = 20;
            } else if (priceChg < -50 && state.cvd > 1000000) {
                imbState = "ABSORPTION (Bullish)";
                imbColor = "var(--accent-green)";
                imbBarPos = 80;
            } else if (Math.abs(state.cvd) > 5000000 && Math.abs(priceChg) < 20) {
                imbState = "PASSIVE WALL";
                imbColor = "var(--accent-purple)";
            }

            ui.imbState.innerText = imbState;
            ui.imbState.style.color = imbColor;
            ui.imbBar.style.width = imbBarPos + '%';
            ui.imbBar.style.background = imbColor;

            // SPOT VS PERP RESTORED
            // Decay perp vols
            state.perp.buy *= 0.99; state.perp.sell *= 0.99;
            const spotDelta = state.vol.buy - state.vol.sell;
            const perpDelta = state.perp.buy - state.perp.sell;
            const deltaDiff = spotDelta - perpDelta; // Positive = Spot Leading, Negative = Perp Leading

            ui.spotCvd.innerText = "S: " + (spotDelta / 1000).toFixed(0) + "k";
            ui.perpCvd.innerText = "P: " + (perpDelta / 1000).toFixed(0) + "k";

            // Re-use logic: 0 = Perp Led (Red), 100 = Spot Led (Green)
            const diffMax = 2000000;
            const diffPct = 50 + ((deltaDiff / diffMax) * 50);
            ui.cvdDiffBar.style.width = Math.max(0, Math.min(100, diffPct)) + '%';
            ui.cvdDiffBar.style.background = deltaDiff > 0 ? 'var(--accent-green)' : 'var(--accent-red)';

            // BASIS
            if (state.btc.current && state.perp.price) {
                const basis = state.btc.current - state.perp.price;
                ui.basisVal.innerText = basis.toFixed(2);
                ui.basisVal.style.color = basis > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                // Positive Basis = Spot > Perp (Contango/Bullish or Spot Premium)
                // Negative Basis = Spot < Perp (Backwardation/Bearish or Perp Premium... ??? Wait)
                // Spot > Perp is usually Bearish (Perp discount) or just normal funding? 
                // Wait. Contango = Futures > Spot. 
                // If Basis = Spot - Perp. 
                // Basis < 0 means Perp > Spot (Contango). 
                // Basis > 0 means Spot > Perp (Backwardation). 
                // Usually Perp > Spot in bull market. So Basis should be negative? 
                // Let's just stick to the value and user can interpret.

                // Correction: Perp is typically slightly above spot in bull. 
                // If Perp is WAY above spot (Deep Negative Basis in this calc), it's Euphoria.
                // If Spot is WAY above Perp (Deep Positive Basis), it's Fear/Capitulation.
            }

            // LIQUIDATIONS
            // Decay liqs
            state.liq.long *= 0.995; state.liq.short *= 0.995;
            const lLong = state.liq.long;
            const lShort = state.liq.short;
            const lTotal = lLong + lShort;

            ui.liqTotal.innerText = (lTotal / 1000).toFixed(0) + 'k';

            const lPct = lTotal > 0 ? (lLong / lTotal) * 100 : 50;
            // Bar shows Long Liqs (Left/Green?) vs Short Liqs (Right/Red?)
            // Let's normalize: Left = Longs Rekt (Sells), Right = Shorts Rekt (Buys).
            // Actually standard: Longs Rekt -> Sell Pressure. Shorts Rekt -> Buy Pressure.
            // Let's color the bar based on who is dominant.

            ui.liqBar.style.width = lPct + '%';
            // If Longs > Shorts (More Longs Rekt), usually bearish outcome (cascade). Color Red?
            // If Shorts > Longs (More Shorts Rekt), usually bullish outcome (squeeze). Color Green?
            ui.liqBar.style.background = lLong > lShort ? 'var(--accent-red)' : 'var(--accent-green)';

            ui.liqLong.innerText = "L: " + (lLong / 1000).toFixed(0) + "k";
            ui.liqShort.innerText = "S: " + (lShort / 1000).toFixed(0) + "k";

            // 4. BREADTH
            // Decay volumes
            state.vol.total *= 0.99; state.vol.whale *= 0.99;

            const whaleRatio = state.vol.total > 0 ? (state.vol.whale / state.vol.total) * 100 : 0;
            ui.whaleDom.innerText = whaleRatio.toFixed(1) + '%';
            ui.whaleBar.style.width = whaleRatio + '%';

            if (whaleRatio > 60) { ui.liqQual.innerText = "INSTITUTIONAL"; ui.liqQual.style.color = "var(--accent-purple)"; }
            else if (whaleRatio < 20) { ui.liqQual.innerText = "RETAIL / NOISE"; ui.liqQual.style.color = "var(--text-dim)"; }
            else { ui.liqQual.innerText = "MIXED"; ui.liqQual.style.color = "var(--text-main)"; }

            // 5. REGIME & MISC
            const chg15 = ((pNow - (h.find(x => x.t >= now - 900000)?.p || pNow)) / pNow) * 100;
            ui.chg15m.innerText = (chg15 > 0 ? "+" : "") + chg15.toFixed(2) + "%";
            ui.chg15m.className = chg15 > 0 ? 'val-norm c-up' : 'val-norm c-down';

            // Vol Compression
            let comp = 0;
            const recent = h.filter(x => now - x.t < 600000); // 10m
            if (recent.length > 0) {
                const highs = recent.map(x => x.p);
                const r = Math.max(...highs) - Math.min(...highs);
                ui.volRange.innerText = r.toFixed(0);
                const rPct = (r / pNow) * 100;
                comp = Math.max(0, Math.min(100, (1 - (rPct / 0.5)) * 100)); // normalized to 0.5% range
                ui.volBar.style.width = comp + '%';
                ui.volBar.style.background = comp > 80 ? "var(--accent-orange)" : "var(--accent-blue)";
            }

            // 6. VWAP Logic
            try {
                if (state.vwap && typeof state.vwap.sumVol === 'number' && state.vwap.sumVol > 0) {
                    const vwap = state.vwap.sumProd / state.vwap.sumVol;
                    ui.vwapVal.innerText = vwap.toFixed(2);

                    const diff = state.btc.current - vwap;
                    const diffPct = (diff / vwap) * 100;

                    ui.vwapDelta.innerText = diff.toFixed(2) + " (" + (diff > 0 ? "+" : "") + diffPct.toFixed(2) + "%)";
                    ui.vwapDelta.style.color = diff > 0 ? "var(--accent-green)" : "var(--accent-red)";

                    if (diffPct > 0.5) { ui.trendRegime.innerText = "BULLISH EXTENSION"; ui.trendRegime.style.color = "var(--accent-green)"; }
                    else if (diffPct < -0.5) { ui.trendRegime.innerText = "BEARISH EXTENSION"; ui.trendRegime.style.color = "var(--accent-red)"; }
                    else if (diff > 0) { ui.trendRegime.innerText = "ABOVE VWAP"; ui.trendRegime.style.color = "var(--text-main)"; }
                    else { ui.trendRegime.innerText = "BELOW VWAP"; ui.trendRegime.style.color = "var(--text-main)"; }
                }
            } catch (e) { console.log(e); }

            // 7. Correlation Logic
            if (state.history.btc.length > 60) {
                // simple correlation
                const n = state.history.btc.length;
                const x = state.history.btc;
                const y = state.history.eth;

                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
                for (let i = 0; i < n; i++) {
                    sumX += x[i];
                    sumY += y[i];
                    sumXY += x[i] * y[i];
                    sumX2 += x[i] * x[i];
                    sumY2 += y[i] * y[i];
                }

                const numer = (n * sumXY) - (sumX * sumY);
                const denom = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));

                if (denom !== 0) {
                    const r = numer / denom;
                    ui.corVal.innerText = r.toFixed(3);
                    if (r > 0.8) ui.corVal.style.color = "var(--accent-green)";
                    else if (r < 0.3) ui.corVal.style.color = "var(--accent-wild)";
                    else ui.corVal.style.color = "var(--text-dim)";
                }
            }

            if (comp > 80) ui.regime.innerText = "COMPRESSED / COIL";
            else if (Math.abs(vel) > 30) ui.regime.innerText = "EXPANSION";
            else ui.regime.innerText = "BALANCED FLOW";

            // REGIME COLOR LOGIC
            let regTxt = "BALANCED FLOW";
            let regCol = "var(--text-main)";

            if (comp > 80) { regTxt = "COMPRESSED / COIL"; regCol = "var(--accent-yellow)"; }
            else if (vel > 25) { regTxt = "BULLISH IMPULSE"; regCol = "var(--accent-green)"; }
            else if (vel < -25) { regTxt = "BEARISH IMPULSE"; regCol = "var(--accent-red)"; }
            else if (chg15 > 0.25) { regTxt = "TREND UP"; regCol = "var(--accent-green)"; }
            else if (chg15 < -0.25) { regTxt = "TREND DOWN"; regCol = "var(--accent-red)"; }

            ui.regime.innerText = regTxt;
            ui.regime.style.color = regCol;

            // Rel Strength
            const ethP = state.alts.eth;
            const solP = state.alts.sol;
            const bnbP = state.alts.bnb;

            if (ethP && state.btc.current) {
                // Ratio changes since load
                const btcP = state.btc.current;
                const btcStart = state.btc.startPrice;
                const ethStart = state.alts.ethStart;

                const btcPerf = (btcP - btcStart) / btcStart;
                const ethPerf = (ethP - ethStart) / ethStart;
                const ethRel = (ethPerf - btcPerf) * 100;

                ui.ethStr.innerText = (ethRel > 0 ? "+" : "") + ethRel.toFixed(2) + '%';
                ui.ethStr.className = ethRel > 0.1 ? 'val-norm c-up' : (ethRel < -0.1 ? 'val-norm c-down' : 'val-norm');

                // Simplified placeholders for SOL/BNB logic (same pattern)
                // In production would refactor into helper
                ui.solStr.innerText = "0.00%";
                ui.bnbStr.innerText = "0.00%";

                // Fix for SOL rel strength calculation
                if (state.alts.solStart > 0) {
                    const solPerf = (solP - state.alts.solStart) / state.alts.solStart;
                    const solRel = (solPerf - btcPerf) * 100;
                    ui.solStr.innerText = (solRel > 0 ? "+" : "") + solRel.toFixed(2) + '%';
                    ui.solStr.className = solRel > 0.1 ? 'val-norm c-up' : (solRel < -0.1 ? 'val-norm c-down' : 'val-norm');
                }

                // Fix for BNB rel strength calculation
                if (state.alts.bnbStart > 0) {
                    const bnbPerf = (bnbP - state.alts.bnbStart) / state.alts.bnbStart;
                    const bnbRel = (bnbPerf - btcPerf) * 100;
                    ui.bnbStr.innerText = (bnbRel > 0 ? "+" : "") + bnbRel.toFixed(2) + '%';
                    ui.bnbStr.className = bnbRel > 0.1 ? 'val-norm c-up' : (bnbRel < -0.1 ? 'val-norm c-down' : 'val-norm');
                }

            }

        }, 1000);

    </script>
</body>

</html>